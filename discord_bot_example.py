#!/usr/bin/env python3
"""
ü§ñ Bot Discord para N8N Workflows
Busca e disponibiliza workflows atrav√©s de comandos Discord
"""

import discord
from discord.ext import commands
import aiohttp
import json
from typing import Optional, Dict, Any
from urllib.parse import quote
import random

# ==================== CONFIGURA√á√ÉO ====================
API_BASE_URL = "https://seu-dominio.railway.app/api"  # ‚Üê ALTERE AQUI
BOT_TOKEN = "seu_token_discord_aqui"  # ‚Üê ALTERE AQUI

# Configurar intents
intents = discord.Intents.default()
intents.message_content = True

# Criar bot
bot = commands.Bot(command_prefix="!", intents=intents)

# ==================== FUN√á√ïES AUXILIARES ====================

async def api_request(endpoint: str, params: Optional[Dict[str, Any]] = None) -> Optional[Dict]:
    """Faz request para a API de workflows"""
    try:
        async with aiohttp.ClientSession() as session:
            url = f"{API_BASE_URL}{endpoint}"
            async with session.get(url, params=params, timeout=10) as response:
                if response.status == 200:
                    return await response.json()
                print(f"‚ùå API Error: {response.status}")
                return None
    except Exception as e:
        print(f"‚ùå Request Error: {e}")
        return None


def create_workflow_embed(workflow: Dict, color: discord.Color = discord.Color.blue()) -> discord.Embed:
    """Cria um embed formatado para um workflow"""
    embed = discord.Embed(
        title=f"üìã {workflow.get('name', 'Sem nome')}",
        description=workflow.get('description', 'Sem descri√ß√£o dispon√≠vel')[:200],
        color=color
    )
    
    # Informa√ß√µes b√°sicas
    embed.add_field(
        name="üìÅ Arquivo",
        value=f"`{workflow.get('filename', 'N/A')}`",
        inline=False
    )
    
    # Estat√≠sticas
    stats_text = (
        f"üìä **N√≥s:** {workflow.get('node_count', 0)}\n"
        f"üîß **Complexidade:** {workflow.get('complexity', 'N/A').title()}\n"
        f"üéØ **Trigger:** {workflow.get('trigger_type', 'N/A')}\n"
        f"{'‚úÖ' if workflow.get('active') else '‚≠ï'} **Status:** {'Ativo' if workflow.get('active') else 'Inativo'}"
    )
    embed.add_field(name="üìà Estat√≠sticas", value=stats_text, inline=True)
    
    # Integra√ß√µes
    integrations = workflow.get('integrations', [])
    if integrations:
        integrations_text = ", ".join(integrations[:5])
        if len(integrations) > 5:
            integrations_text += f" +{len(integrations) - 5} mais"
        embed.add_field(name="üîå Integra√ß√µes", value=integrations_text, inline=True)
    
    # Link de download
    filename = workflow.get('filename', '')
    if filename:
        download_url = f"{API_BASE_URL}/workflows/{filename}/download"
        embed.add_field(
            name="üì• Download",
            value=f"[Clique aqui para baixar]({download_url})",
            inline=False
        )
    
    return embed


# ==================== COMANDOS DO BOT ====================

@bot.event
async def on_ready():
    """Evento quando o bot est√° pronto"""
    print("=" * 50)
    print(f"‚úÖ Bot conectado como: {bot.user}")
    print(f"üåê API Base URL: {API_BASE_URL}")
    print(f"üìä Servidores conectados: {len(bot.guilds)}")
    print(f"üë• Usu√°rios alcan√ßados: {sum(guild.member_count for guild in bot.guilds)}")
    print("=" * 50)
    
    # Testar conex√£o com API
    stats = await api_request("/stats")
    if stats:
        print(f"‚úÖ API Online - {stats.get('total', 0)} workflows dispon√≠veis")
    else:
        print("‚ö†Ô∏è API n√£o respondeu - verifique a configura√ß√£o")


@bot.command(name="stats")
async def stats(ctx):
    """üìä Mostra estat√≠sticas dos workflows dispon√≠veis"""
    async with ctx.typing():
        data = await api_request("/stats")
        
        if not data:
            await ctx.send("‚ùå Erro ao buscar estat√≠sticas da API")
            return
        
        embed = discord.Embed(
            title="üìä Estat√≠sticas de Workflows N8N",
            description="Biblioteca completa de automa√ß√µes",
            color=discord.Color.blue()
        )
        
        # Estat√≠sticas principais
        embed.add_field(
            name="üìö Workflows",
            value=f"**Total:** {data.get('total', 0)}\n"
                  f"**Ativos:** {data.get('active', 0)}\n"
                  f"**Inativos:** {data.get('inactive', 0)}",
            inline=True
        )
        
        embed.add_field(
            name="üîß Recursos",
            value=f"**Integra√ß√µes:** {data.get('unique_integrations', 0)}\n"
                  f"**Total de N√≥s:** {data.get('total_nodes', 0):,}",
            inline=True
        )
        
        # Triggers
        triggers = data.get('triggers', {})
        if triggers:
            trigger_text = "\n".join([
                f"**{key}:** {value}" for key, value in triggers.items()
            ])
            embed.add_field(name="üéØ Tipos de Trigger", value=trigger_text, inline=False)
        
        # Complexidade
        complexity = data.get('complexity', {})
        if complexity:
            complexity_text = "\n".join([
                f"**{key.title()}:** {value}" for key, value in complexity.items()
            ])
            embed.add_field(name="üìà Complexidade", value=complexity_text, inline=False)
        
        # √öltima indexa√ß√£o
        last_indexed = data.get('last_indexed', 'N/A')
        embed.set_footer(text=f"√öltima atualiza√ß√£o: {last_indexed}")
        
        await ctx.send(embed=embed)


@bot.command(name="search", aliases=["buscar", "find"])
async def search(ctx, *, query: str):
    """üîç Busca workflows por termo
    
    Uso: !search telegram
         !search openai bot
    """
    async with ctx.typing():
        data = await api_request("/workflows", {"q": query, "per_page": 10})
        
        if not data or not data.get('workflows'):
            await ctx.send(f"‚ùå Nenhum workflow encontrado para: **{query}**")
            return
        
        workflows = data['workflows']
        total = data['total']
        
        embed = discord.Embed(
            title=f"üîç Resultados para: {query}",
            description=f"Encontrados **{total}** workflows (mostrando at√© 10)",
            color=discord.Color.green()
        )
        
        for i, wf in enumerate(workflows[:10], 1):
            integrations = ", ".join(wf.get('integrations', [])[:3])
            if not integrations:
                integrations = "N/A"
            
            embed.add_field(
                name=f"{i}. {wf.get('name', 'Sem nome')}",
                value=f"üìÅ `{wf.get('filename', 'N/A')}`\n"
                      f"üîß {integrations}\n"
                      f"üìä {wf.get('node_count', 0)} n√≥s | {wf.get('complexity', 'N/A')} complexity",
                inline=False
            )
        
        if total > 10:
            embed.set_footer(text=f"üí° Use !download <arquivo> para baixar um workflow espec√≠fico")
        
        await ctx.send(embed=embed)


@bot.command(name="download", aliases=["baixar", "get"])
async def download(ctx, *, filename: str):
    """üì• Baixa um workflow espec√≠fico
    
    Uso: !download 0001_Telegram_Bot_Webhook.json
    """
    # Remover backticks se o usu√°rio copiou do comando search
    filename = filename.strip('`')
    
    async with ctx.typing():
        data = await api_request(f"/workflows/{filename}")
        
        if not data:
            await ctx.send(f"‚ùå Workflow n√£o encontrado: **{filename}**\n"
                          f"üí° Use `!search <termo>` para encontrar workflows")
            return
        
        embed = create_workflow_embed(data, discord.Color.purple())
        await ctx.send(embed=embed)


@bot.command(name="categories", aliases=["categorias", "cats"])
async def categories(ctx):
    """üìÇ Lista todas as categorias dispon√≠veis"""
    async with ctx.typing():
        data = await api_request("/categories")
        
        if not data:
            await ctx.send("‚ùå Erro ao buscar categorias")
            return
        
        cats = data.get('categories', [])
        
        embed = discord.Embed(
            title="üìÇ Categorias Dispon√≠veis",
            description=f"Total: **{len(cats)}** categorias",
            color=discord.Color.orange()
        )
        
        # Dividir em duas colunas
        half = (len(cats) + 1) // 2
        
        if cats:
            embed.add_field(
                name="Categorias (1/2)",
                value="\n".join(f"‚Ä¢ {cat}" for cat in cats[:half]),
                inline=True
            )
            embed.add_field(
                name="Categorias (2/2)",
                value="\n".join(f"‚Ä¢ {cat}" for cat in cats[half:]),
                inline=True
            )
        
        embed.set_footer(text="üí° Use !category <nome> para buscar workflows dessa categoria")
        
        await ctx.send(embed=embed)


@bot.command(name="category", aliases=["cat", "categoria"])
async def category(ctx, *, category_name: str):
    """üè∑Ô∏è Busca workflows por categoria
    
    Uso: !category Communication & Messaging
         !category AI Agent Development
    """
    async with ctx.typing():
        # URL encode da categoria
        encoded_cat = quote(category_name)
        data = await api_request(f"/workflows/category/{encoded_cat}")
        
        if not data or not data.get('workflows'):
            await ctx.send(f"‚ùå Nenhum workflow na categoria: **{category_name}**\n"
                          f"üí° Use `!categories` para ver categorias dispon√≠veis")
            return
        
        workflows = data['workflows']
        
        embed = discord.Embed(
            title=f"üìÇ Categoria: {category_name}",
            description=f"**{len(workflows)}** workflows encontrados",
            color=discord.Color.blue()
        )
        
        for i, wf in enumerate(workflows[:10], 1):
            embed.add_field(
                name=f"{i}. {wf.get('name', 'Sem nome')}",
                value=f"üìÅ `{wf.get('filename', 'N/A')}`\n"
                      f"üìä {wf.get('node_count', 0)} n√≥s | {wf.get('trigger_type', 'N/A')}",
                inline=False
            )
        
        if len(workflows) > 10:
            embed.set_footer(text=f"Mostrando 10 de {len(workflows)} workflows")
        
        await ctx.send(embed=embed)


@bot.command(name="random", aliases=["aleatorio", "rand"])
async def random_workflow(ctx):
    """üé≤ Mostra um workflow aleat√≥rio"""
    async with ctx.typing():
        # Buscar workflows (primeira p√°gina com 100 itens)
        data = await api_request("/workflows", {"per_page": 100})
        
        if not data or not data.get('workflows'):
            await ctx.send("‚ùå Erro ao buscar workflows")
            return
        
        wf = random.choice(data['workflows'])
        
        embed = create_workflow_embed(wf, discord.Color.gold())
        embed.title = f"üé≤ Workflow Aleat√≥rio: {wf.get('name', 'Sem nome')}"
        
        await ctx.send(embed=embed)


@bot.command(name="filter", aliases=["filtrar"])
async def filter_workflows(ctx, trigger: str = "all", complexity: str = "all"):
    """üîé Filtra workflows por trigger e complexidade
    
    Uso: !filter Webhook medium
         !filter Scheduled high
         !filter Manual all
    
    Triggers: Webhook, Scheduled, Manual, Complex, all
    Complexity: low, medium, high, all
    """
    async with ctx.typing():
        data = await api_request("/workflows", {
            "trigger": trigger,
            "complexity": complexity,
            "per_page": 10
        })
        
        if not data or not data.get('workflows'):
            await ctx.send(f"‚ùå Nenhum workflow encontrado com os filtros:\n"
                          f"**Trigger:** {trigger} | **Complexidade:** {complexity}")
            return
        
        workflows = data['workflows']
        total = data['total']
        
        embed = discord.Embed(
            title=f"üîé Workflows Filtrados",
            description=f"**Trigger:** {trigger} | **Complexidade:** {complexity}\n"
                       f"Encontrados: **{total}** workflows (mostrando 10)",
            color=discord.Color.teal()
        )
        
        for i, wf in enumerate(workflows[:10], 1):
            embed.add_field(
                name=f"{i}. {wf.get('name', 'Sem nome')}",
                value=f"üìÅ `{wf.get('filename', 'N/A')}`\n"
                      f"üìä {wf.get('node_count', 0)} n√≥s",
                inline=False
            )
        
        await ctx.send(embed=embed)


@bot.command(name="api_status", aliases=["status", "ping"])
async def api_status(ctx):
    """üè• Verifica o status da API"""
    async with ctx.typing():
        try:
            data = await api_request("/stats")
            
            if data:
                embed = discord.Embed(
                    title="‚úÖ API Online",
                    description="A API est√° funcionando normalmente",
                    color=discord.Color.green()
                )
                embed.add_field(
                    name="üìä Workflows Dispon√≠veis",
                    value=f"{data.get('total', 0)} workflows",
                    inline=True
                )
                embed.add_field(
                    name="üîå Integra√ß√µes",
                    value=f"{data.get('unique_integrations', 0)} servi√ßos",
                    inline=True
                )
                embed.add_field(
                    name="üåê URL",
                    value=f"[{API_BASE_URL}]({API_BASE_URL})",
                    inline=False
                )
            else:
                embed = discord.Embed(
                    title="‚ö†Ô∏è API com Problemas",
                    description="A API respondeu mas sem dados v√°lidos",
                    color=discord.Color.orange()
                )
        except Exception as e:
            embed = discord.Embed(
                title="‚ùå API Offline",
                description=f"N√£o foi poss√≠vel conectar √† API\n\n**Erro:** {str(e)}",
                color=discord.Color.red()
            )
        
        await ctx.send(embed=embed)


@bot.command(name="help_workflows", aliases=["ajuda", "comandos"])
async def help_workflows(ctx):
    """‚ùì Mostra ajuda dos comandos de workflows"""
    embed = discord.Embed(
        title="ü§ñ Comandos de Workflows N8N",
        description="Lista completa de comandos dispon√≠veis",
        color=discord.Color.blue()
    )
    
    commands_list = [
        ("!stats", "üìä Mostra estat√≠sticas gerais dos workflows"),
        ("!search <termo>", "üîç Busca workflows por palavra-chave"),
        ("!download <arquivo>", "üì• Baixa um workflow espec√≠fico"),
        ("!categories", "üìÇ Lista todas as categorias dispon√≠veis"),
        ("!category <nome>", "üè∑Ô∏è Busca workflows por categoria"),
        ("!filter <trigger> <complexity>", "üîé Filtra workflows por crit√©rios"),
        ("!random", "üé≤ Mostra um workflow aleat√≥rio"),
        ("!api_status", "üè• Verifica status da API"),
        ("!help_workflows", "‚ùì Mostra esta mensagem de ajuda"),
    ]
    
    for cmd, desc in commands_list:
        embed.add_field(name=cmd, value=desc, inline=False)
    
    embed.set_footer(text="Bot de Workflows N8N | 2057+ workflows dispon√≠veis")
    
    await ctx.send(embed=embed)


@bot.event
async def on_command_error(ctx, error):
    """Tratamento de erros"""
    if isinstance(error, commands.CommandNotFound):
        await ctx.send(f"‚ùå Comando n√£o encontrado. Use `!help_workflows` para ver comandos dispon√≠veis.")
    elif isinstance(error, commands.MissingRequiredArgument):
        await ctx.send(f"‚ùå Par√¢metro faltando. Use `!help_workflows` para ver como usar o comando.")
    else:
        print(f"Erro: {error}")
        await ctx.send(f"‚ùå Ocorreu um erro ao executar o comando.")


# ==================== INICIAR BOT ====================

if __name__ == "__main__":
    print("üöÄ Iniciando Bot Discord...")
    print(f"üì° API: {API_BASE_URL}")
    print("-" * 50)
    
    try:
        bot.run(BOT_TOKEN)
    except discord.LoginFailure:
        print("‚ùå Token inv√°lido! Verifique o BOT_TOKEN no c√≥digo.")
    except Exception as e:
        print(f"‚ùå Erro ao iniciar bot: {e}")
